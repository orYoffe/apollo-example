"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("apollo-cache"),r=require("apollo-utilities"),i=require("optimism"),n=require("ts-invariant"),a=new Map;if(a.set(1,2)!==a){var o=a.set;Map.prototype.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return o.apply(this,e),this}}var s=new Set;if(s.add(3)!==s){var c=s.add;Set.prototype.add=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return c.apply(this,e),this}}var u={};"function"==typeof Object.freeze&&Object.freeze(u);try{a.set(u,u).delete(u)}catch(e){var l=function(e){return e&&function(t){try{a.set(t,t).delete(t)}finally{return e.call(Object,t)}}};Object.freeze=l(Object.freeze),Object.seal=l(Object.seal),Object.preventExtensions=l(Object.preventExtensions)}var d=!1;function p(){var e=!d;return r.isTest()||(d=!0),e}var f=function(){function e(){}return e.prototype.ensureReady=function(){return Promise.resolve()},e.prototype.canBypassInit=function(){return!0},e.prototype.match=function(e,t,r){var i=r.store.get(e.id);return!i&&"ROOT_QUERY"===e.id||!!i&&(i.__typename&&i.__typename===t||(p(),"heuristic"))},e}(),h=function(){function e(e){e&&e.introspectionQueryResultData?(this.possibleTypesMap=this.parseIntrospectionResult(e.introspectionQueryResultData),this.isReady=!0):this.isReady=!1,this.match=this.match.bind(this)}return e.prototype.match=function(e,t,r){n.invariant(this.isReady);var i=r.store.get(e.id);if(!i)return!1;if(n.invariant(i.__typename),i.__typename===t)return!0;var a=this.possibleTypesMap[t];return!!(a&&a.indexOf(i.__typename)>-1)},e.prototype.parseIntrospectionResult=function(e){var t={};return e.__schema.types.forEach(function(e){"UNION"!==e.kind&&"INTERFACE"!==e.kind||(t[e.name]=e.possibleTypes.map(function(e){return e.name}))}),t},e}(),y=function(){function e(){this.children=null,this.key=null}return e.prototype.lookup=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lookupArray(e)},e.prototype.lookupArray=function(e){var t=this;return e.forEach(function(e){t=t.getOrCreate(e)}),t.key||(t.key=Object.create(null))},e.prototype.getOrCreate=function(t){var r=this.children||(this.children=new Map),i=r.get(t);return i||r.set(t,i=new e),i},e}(),m=Object.prototype.hasOwnProperty,v=function(){function e(e){void 0===e&&(e=Object.create(null));var t=this;this.data=e,this.depend=i.wrap(function(e){return t.data[e]},{disposable:!0,makeCacheKey:function(e){return e}})}return e.prototype.toObject=function(){return this.data},e.prototype.get=function(e){return this.depend(e),this.data[e]},e.prototype.set=function(e,t){t!==this.data[e]&&(this.data[e]=t,this.depend.dirty(e))},e.prototype.delete=function(e){m.call(this.data,e)&&(delete this.data[e],this.depend.dirty(e))},e.prototype.clear=function(){this.replace(null)},e.prototype.replace=function(e){var t=this;e?(Object.keys(e).forEach(function(r){t.set(r,e[r])}),Object.keys(this.data).forEach(function(r){m.call(e,r)||t.delete(r)})):Object.keys(this.data).forEach(function(e){t.delete(e)})},e}();function g(e){return new v(e)}var b=function(){function t(e){void 0===e&&(e=new y);var t=this;this.cacheKeyRoot=e;var r=this,n=r.executeStoreQuery,a=r.executeSelectionSet;this.executeStoreQuery=i.wrap(function(e){return n.call(t,e)},{makeCacheKey:function(e){var t=e.query,i=e.rootValue,n=e.contextValue,a=e.variableValues,o=e.fragmentMatcher;if(n.store instanceof v)return r.cacheKeyRoot.lookup(t,n.store,o,JSON.stringify(a),i.id)}}),this.executeSelectionSet=i.wrap(function(e){return a.call(t,e)},{makeCacheKey:function(e){var t=e.selectionSet,i=e.rootValue,n=e.execContext;if(n.contextValue.store instanceof v)return r.cacheKeyRoot.lookup(t,n.contextValue.store,n.fragmentMatcher,JSON.stringify(n.variableValues),i.id)}})}return t.prototype.readQueryFromStore=function(t){return this.diffQueryAgainstStore(e.__assign({},t,{returnPartialData:!1})).result},t.prototype.diffQueryAgainstStore=function(e){var t=e.store,i=e.query,a=e.variables,o=e.previousResult,s=e.returnPartialData,c=void 0===s||s,u=e.rootId,l=void 0===u?"ROOT_QUERY":u,d=e.fragmentMatcherFunction,p=e.config,f=r.getQueryDefinition(i);a=r.assign({},r.getDefaultValues(f),a);var h={store:t,dataIdFromObject:p&&p.dataIdFromObject||null,cacheRedirects:p&&p.cacheRedirects||{}},y=this.executeStoreQuery({query:i,rootValue:{type:"id",id:l,generated:!0,typename:"Query"},contextValue:h,variableValues:a,fragmentMatcher:d}),m=y.missing&&y.missing.length>0;return m&&!c&&y.missing.forEach(function(e){if(!e.tolerable)throw new n.InvariantError}),o&&r.isEqual(o,y.result)&&(y.result=o),{result:y.result,complete:!m}},t.prototype.executeStoreQuery=function(e){var t=e.query,i=e.rootValue,n=e.contextValue,a=e.variableValues,o=e.fragmentMatcher,s=void 0===o?x:o,c=r.getMainDefinition(t),u=r.getFragmentDefinitions(t),l={query:t,fragmentMap:r.createFragmentMap(u),contextValue:n,variableValues:a,fragmentMatcher:s};return this.executeSelectionSet({selectionSet:c.selectionSet,rootValue:i,execContext:l})},t.prototype.executeSelectionSet=function(t){var i=this,a=t.selectionSet,o=t.rootValue,s=t.execContext,c=s.fragmentMap,u=s.contextValue,l=s.variableValues,d={result:null},p=[],f=u.store.get(o.id),h=f&&f.__typename||"ROOT_QUERY"===o.id&&"Query"||void 0;function y(e){var t;return e.missing&&(d.missing=d.missing||[],(t=d.missing).push.apply(t,e.missing)),e.result}return a.selections.forEach(function(t){var a;if(r.shouldInclude(t,l))if(r.isField(t)){var d=y(i.executeField(f,h,t,s));void 0!==d&&p.push(((a={})[r.resultKeyNameFromField(t)]=d,a))}else{var m=void 0;if(r.isInlineFragment(t))m=t;else if(!(m=c[t.name.value]))throw new n.InvariantError;var v=m.typeCondition.name.value,g=s.fragmentMatcher(o,v,u);if(g){var b=i.executeSelectionSet({selectionSet:m.selectionSet,rootValue:o,execContext:s});"heuristic"===g&&b.missing&&(b=e.__assign({},b,{missing:b.missing.map(function(t){return e.__assign({},t,{tolerable:!0})})})),p.push(y(b))}}}),d.result=r.mergeDeepArray(p),d},t.prototype.executeField=function(e,t,i,n){var a=n.variableValues,o=n.contextValue,s=I(e,t,i.name.value,r.argumentsObjectFromField(i,a),o,{resultKey:r.resultKeyNameFromField(i),directives:r.getDirectiveInfoFromField(i,a)});return Array.isArray(s.result)?this.combineExecResults(s,this.executeSubSelectedArray(i,s.result,n)):i.selectionSet?null==s.result?s:this.combineExecResults(s,this.executeSelectionSet({selectionSet:i.selectionSet,rootValue:s.result,execContext:n})):(S(i,s.result),s)},t.prototype.combineExecResults=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=null;return e.forEach(function(e){e.missing&&(r=r||[]).push.apply(r,e.missing)}),{result:e.pop().result,missing:r}},t.prototype.executeSubSelectedArray=function(e,t,r){var i=this,n=null;function a(e){return e.missing&&(n=n||[]).push.apply(n,e.missing),e.result}return{result:t=t.map(function(t){return null===t?null:Array.isArray(t)?a(i.executeSubSelectedArray(e,t,r)):e.selectionSet?a(i.executeSelectionSet({selectionSet:e.selectionSet,rootValue:t,execContext:r})):(S(e,t),t)}),missing:n}},t}();function S(e,t){if(!e.selectionSet&&r.isIdValue(t))throw new n.InvariantError}function x(){return!0}function O(e){n.invariant(r.isIdValue(e))}function I(e,t,i,n,a,o){o.resultKey;var s=o.directives,c=i;(n||s)&&(c=r.getStoreKeyName(c,n,s));var u=void 0;if(e&&void 0===(u=e[c])&&a.cacheRedirects&&"string"==typeof t){var l=a.cacheRedirects[t];if(l){var d=l[i];d&&(u=d(e,n,{getCacheKey:function(e){return r.toIdValue({id:a.dataIdFromObject(e),typename:e.__typename})}}))}}return void 0===u?{result:u,missing:[{object:e,fieldName:c,tolerable:!1}]}:(r.isJsonValue(u)&&(u=u.json),{result:u})}var F=function(){function e(e){void 0===e&&(e=Object.create(null)),this.data=e}return e.prototype.toObject=function(){return this.data},e.prototype.get=function(e){return this.data[e]},e.prototype.set=function(e,t){this.data[e]=t},e.prototype.delete=function(e){this.data[e]=void 0},e.prototype.clear=function(){this.data=Object.create(null)},e.prototype.replace=function(e){this.data=e||Object.create(null)},e}();function _(e){return new F(e)}var R=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="WriteError",e}return e.__extends(r,t),r}(Error);function w(e,t){var r=new R("Error writing result to store for query:\n "+JSON.stringify(t));return r.message+="\n"+e.message,r.stack=e.stack,r}var j=function(){function t(){}return t.prototype.writeQueryToStore=function(e){var t=e.query,r=e.result,i=e.store,n=void 0===i?g():i,a=e.variables,o=e.dataIdFromObject,s=e.fragmentMatcherFunction;return this.writeResultToStore({dataId:"ROOT_QUERY",result:r,document:t,store:n,variables:a,dataIdFromObject:o,fragmentMatcherFunction:s})},t.prototype.writeResultToStore=function(e){var t=e.dataId,i=e.result,n=e.document,a=e.store,o=void 0===a?g():a,s=e.variables,c=e.dataIdFromObject,u=e.fragmentMatcherFunction,l=r.getOperationDefinition(n);try{return this.writeSelectionSetToStore({result:i,dataId:t,selectionSet:l.selectionSet,context:{store:o,processedData:{},variables:r.assign({},r.getDefaultValues(l),s),dataIdFromObject:c,fragmentMap:r.createFragmentMap(r.getFragmentDefinitions(n)),fragmentMatcherFunction:u}})}catch(e){throw w(e,n)}},t.prototype.writeSelectionSetToStore=function(e){var t=this,i=e.result,a=e.dataId,o=e.selectionSet,s=e.context,c=s.variables,u=s.store,l=s.fragmentMap;return o.selections.forEach(function(e){if(r.shouldInclude(e,c))if(r.isField(e)){var o=r.resultKeyNameFromField(e),u=i[o];if(void 0!==u)t.writeFieldToStore({dataId:a,value:u,field:e,context:s});else{var d=!1,p=!1;e.directives&&e.directives.length&&(d=e.directives.some(function(e){return e.name&&"defer"===e.name.value}),p=e.directives.some(function(e){return e.name&&"client"===e.name.value})),!d&&!p&&s.fragmentMatcherFunction}}else{var f=void 0;r.isInlineFragment(e)?f=e:(f=(l||{})[e.name.value],n.invariant(f));var h=!0;if(s.fragmentMatcherFunction&&f.typeCondition){var y=r.toIdValue({id:"self",typename:void 0}),m={store:new F({self:i}),cacheRedirects:{}},v=s.fragmentMatcherFunction(y,f.typeCondition.name.value,m);r.isProduction(),h=!!v}h&&t.writeSelectionSetToStore({result:i,selectionSet:f.selectionSet,dataId:a,context:s})}}),u},t.prototype.writeFieldToStore=function(t){var i,a,o,s=t.field,c=t.value,u=t.dataId,l=t.context,d=l.variables,p=l.dataIdFromObject,f=l.store,h=r.storeKeyNameFromField(s,d);if(s.selectionSet&&null!==c)if(Array.isArray(c)){var y=u+"."+h;a=this.processArrayValue(c,y,s.selectionSet,l)}else{var m=u+"."+h,v=!0;if(V(m)||(m="$"+m),p){var g=p(c);n.invariant(!g||!V(g)),(g||"number"==typeof g&&0===g)&&(m=g,v=!1)}D(m,s,l.processedData)||this.writeSelectionSetToStore({dataId:m,result:c,selectionSet:s.selectionSet,context:l});var b=c.__typename;a=r.toIdValue({id:m,typename:b},v);var S=(o=f.get(u))&&o[h];if(S!==a&&r.isIdValue(S)){var x=void 0!==S.typename,O=void 0!==b,I=x&&O&&S.typename!==b;n.invariant(!v||S.generated||I),n.invariant(!x||O),S.generated&&(I?v||f.delete(S.id):M(S.id,a.id,f))}}else a=null!=c&&"object"==typeof c?{type:"json",json:c}:c;(o=f.get(u))&&r.isEqual(a,o[h])||f.set(u,e.__assign({},o,((i={})[h]=a,i)))},t.prototype.processArrayValue=function(e,t,i,n){var a=this;return e.map(function(e,o){if(null===e)return null;var s=t+"."+o;if(Array.isArray(e))return a.processArrayValue(e,s,i,n);var c=!0;if(n.dataIdFromObject){var u=n.dataIdFromObject(e);u&&(s=u,c=!1)}return D(s,i,n.processedData)||a.writeSelectionSetToStore({dataId:s,result:e,selectionSet:i,context:n}),r.toIdValue({id:s,typename:e.__typename},c)})},t}();function V(e){return"$"===e[0]}function M(t,i,n){if(t===i)return!1;var a=n.get(t),o=n.get(i),s=!1;Object.keys(a).forEach(function(e){var t=a[e],i=o[e];r.isIdValue(t)&&V(t.id)&&r.isIdValue(i)&&!r.isEqual(t,i)&&M(t.id,i.id,n)&&(s=!0)}),n.delete(t);var c=e.__assign({},a,o);return r.isEqual(c,o)?s:(n.set(i,c),!0)}function D(e,t,r){if(!r)return!1;if(r[e]){if(r[e].indexOf(t)>=0)return!0;r[e].push(t)}else r[e]=[t];return!1}var E={fragmentMatcher:new f,dataIdFromObject:T,addTypename:!0,resultCaching:!0};function T(e){if(e.__typename){if(void 0!==e.id)return e.__typename+":"+e.id;if(void 0!==e._id)return e.__typename+":"+e._id}return null}var C=Object.prototype.hasOwnProperty,q=function(t){function r(e,r,i){var n=t.call(this,Object.create(null))||this;return n.optimisticId=e,n.parent=r,n.transaction=i,n}return e.__extends(r,t),r.prototype.toObject=function(){return e.__assign({},this.parent.toObject(),this.data)},r.prototype.get=function(e){return C.call(this.data,e)?this.data[e]:this.parent.get(e)},r}(F),k=function(t){function a(r){void 0===r&&(r={});var n=t.call(this)||this;n.watches=new Set,n.typenameDocumentCache=new Map,n.cacheKeyRoot=new y,n.silenceBroadcast=!1,n.config=e.__assign({},E,r),n.config.customResolvers&&(n.config.cacheRedirects=n.config.customResolvers),n.config.cacheResolvers&&(n.config.cacheRedirects=n.config.cacheResolvers),n.addTypename=n.config.addTypename,n.data=n.config.resultCaching?new v:new F,n.optimisticData=n.data,n.storeReader=new b(n.cacheKeyRoot),n.storeWriter=new j;var a=n,o=a.maybeBroadcastWatch;return n.maybeBroadcastWatch=i.wrap(function(e){return o.call(n,e)},{makeCacheKey:function(e){if(!e.optimistic&&!e.previousResult)return a.data instanceof v?a.cacheKeyRoot.lookup(e.query,JSON.stringify(e.variables)):void 0}}),n}return e.__extends(a,t),a.prototype.restore=function(e){return e&&this.data.replace(e),this},a.prototype.extract=function(e){return void 0===e&&(e=!1),(e?this.optimisticData:this.data).toObject()},a.prototype.read=function(e){return"string"==typeof e.rootId&&void 0===this.data.get(e.rootId)?null:this.storeReader.readQueryFromStore({store:e.optimistic?this.optimisticData:this.data,query:this.transformDocument(e.query),variables:e.variables,rootId:e.rootId,fragmentMatcherFunction:this.config.fragmentMatcher.match,previousResult:e.previousResult,config:this.config})},a.prototype.write=function(e){this.storeWriter.writeResultToStore({dataId:e.dataId,result:e.result,variables:e.variables,document:this.transformDocument(e.query),store:this.data,dataIdFromObject:this.config.dataIdFromObject,fragmentMatcherFunction:this.config.fragmentMatcher.match}),this.broadcastWatches()},a.prototype.diff=function(e){return this.storeReader.diffQueryAgainstStore({store:e.optimistic?this.optimisticData:this.data,query:this.transformDocument(e.query),variables:e.variables,returnPartialData:e.returnPartialData,previousResult:e.previousResult,fragmentMatcherFunction:this.config.fragmentMatcher.match,config:this.config})},a.prototype.watch=function(e){var t=this;return this.watches.add(e),function(){t.watches.delete(e)}},a.prototype.evict=function(e){throw new n.InvariantError},a.prototype.reset=function(){return this.data.clear(),this.broadcastWatches(),Promise.resolve()},a.prototype.removeOptimistic=function(e){for(var t=[],r=0,i=this.optimisticData;i instanceof q;)i.optimisticId===e?++r:t.push(i),i=i.parent;if(r>0){for(this.optimisticData=i;t.length>0;){var n=t.pop();this.performTransaction(n.transaction,n.optimisticId)}this.broadcastWatches()}},a.prototype.performTransaction=function(e,t){var r=this.data,i=this.silenceBroadcast;this.silenceBroadcast=!0,"string"==typeof t&&(this.data=this.optimisticData=new q(t,this.optimisticData,e));try{e(this)}finally{this.silenceBroadcast=i,this.data=r}this.broadcastWatches()},a.prototype.recordOptimisticTransaction=function(e,t){return this.performTransaction(e,t)},a.prototype.transformDocument=function(e){if(this.addTypename){var t=this.typenameDocumentCache.get(e);return t||(t=r.addTypenameToDocument(e),this.typenameDocumentCache.set(e,t),this.typenameDocumentCache.set(t,t)),t}return e},a.prototype.broadcastWatches=function(){var e=this;this.silenceBroadcast||this.watches.forEach(function(t){return e.maybeBroadcastWatch(t)})},a.prototype.maybeBroadcastWatch=function(e){e.callback(this.diff({query:e.query,variables:e.variables,previousResult:e.previousResult&&e.previousResult(),optimistic:e.optimistic}))},a}(t.ApolloCache);exports.InMemoryCache=k,exports.defaultDataIdFromObject=T,exports.StoreReader=b,exports.assertIdValue=O,exports.WriteError=R,exports.enhanceErrorWithDocument=w,exports.StoreWriter=j,exports.HeuristicFragmentMatcher=f,exports.IntrospectionFragmentMatcher=h,exports.ObjectCache=F,exports.defaultNormalizedCacheFactory=_;
